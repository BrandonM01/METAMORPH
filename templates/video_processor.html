{% extends "base.html" %}

{% block title %}Video Processor{% endblock %}

{% block content %}
<h1>Video Processor</h1>

<div class="form-container">
  <form class="upload-form" id="videoForm" action="{{ url_for('process_videos') }}" method="post" enctype="multipart/form-data">
    <label class="form-label">Select Videos:</label>
    <input class="form-input" type="file" name="videos" multiple required id="fileInput">

    <label class="form-label">Batch Size (number of variants per video):</label>
    {% if current_user.plan == 'free' %}
      <input class="form-input" type="number" name="batch_size" value="5" min="1" max="5" readonly>
      <p style="font-size: 13px; color: grey;">Upgrade to increase batch size</p>
    {% elif current_user.plan == 'pro' %}
      <input class="form-input" type="number" name="batch_size" value="5" min="1" max="25" required>
    {% else %}
      <input class="form-input" type="number" name="batch_size" value="5" min="1" max="50" required>
    {% endif %}

    <label class="form-label">Intensity (1–100):</label>
    <input class="form-slider" type="range" name="intensity" min="1" max="100" value="30"
           oninput="this.nextElementSibling.value = this.value">
    <output>30</output>

    <div class="checkbox-group">
      <label><input type="checkbox" name="adjust_contrast"> Adjust Contrast</label><br>
      <label><input type="checkbox" name="adjust_brightness"> Adjust Brightness</label><br>
      <label><input type="checkbox" name="rotate"> Rotate Slightly</label><br>
      <label><input type="checkbox" name="crop"> Crop Slightly</label><br>
      <label><input type="checkbox" name="flip_horizontal"> Flip Horizontally</label>
    </div>

    <button class="main-button" id="submitBtn" type="submit">Process Videos</button>

    <div class="spinner" id="spinner" style="display:none; margin-top:20px;">
      <img src="{{ url_for('static', filename='spinner.gif') }}" alt="Loading..." style="width:40px;height:40px;">
    </div>

    <div id="downloadSection" style="display:none; margin-top:30px;">
      <a id="downloadLink" class="main-button"
         style="background-color: green; text-decoration: none;">Download Ready!</a>
    </div>

    <button class="main-button" id="newUploadBtn" type="button"
            onclick="resetUpload()" style="display:none; margin-top:20px;">
      Start New Upload
    </button>
  </form>

  <a href="{{ url_for('home') }}" class="back-link">Back Home</a>
</div>

<script>
  const form            = document.getElementById('videoForm');
  const spinner         = document.getElementById('spinner');
  const downloadSection = document.getElementById('downloadSection');
  const downloadLink    = document.getElementById('downloadLink');
  const submitBtn       = document.getElementById('submitBtn');
  const newUploadBtn    = document.getElementById('newUploadBtn');
  const fileInput       = document.getElementById('fileInput');

  form.addEventListener('submit', e => {
    e.preventDefault();
    const formData = new FormData(form);

    // Hide submit, show spinner
    submitBtn.style.display = 'none';
    spinner.style.display   = 'block';
    downloadSection.style.display = 'none';
    newUploadBtn.style.display    = 'none';

    fetch(form.action, { method: 'POST', body: formData })
      .then(response => response.json())
      .then(data => {
        spinner.style.display = 'none';

        if (data.error) {
          alert('❌ Video processing failed:\n' + (data.detail || data.error));
          console.error('Server error:', data);
          submitBtn.style.display = 'inline-block';
          return;
        }

        if (!data.zip_filename) {
          alert('❌ Unexpected server response. No download link available.');
          submitBtn.style.display = 'inline-block';
          return;
        }

        // Success
        downloadLink.href = `/download-zip/${data.zip_filename}`;
        downloadSection.style.display = 'block';
        newUploadBtn.style.display    = 'inline-block';
        downloadSection.scrollIntoView({ behavior: 'smooth' });
      })
      .catch(err => {
        spinner.style.display = 'none';
        alert('⚠️ Network error. See console for details.');
        console.error(err);
        submitBtn.style.display = 'inline-block';
      });
  });

  function resetUpload() {
    fileInput.value = '';
    downloadSection.style.display = 'none';
    submitBtn.style.display       = 'inline-block';
    newUploadBtn.style.display    = 'none';
  }
</script>
{% endblock %}
